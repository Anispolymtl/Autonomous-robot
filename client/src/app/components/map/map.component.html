<div class="map-wrapper">
  <!-- Map Container avec Canvas -->
  <div class="map-container" 
       (mousemove)="onCanvasHover($event)"
       (mouseleave)="onCanvasLeave()">
    <canvas 
      #mapCanvas 
      id="mapCanvas" 
      (click)="onCanvasClick($event)">
    </canvas>
    
    <!-- Crosshair Indicator -->
    <div class="crosshair" 
         *ngIf="hoverCoords"
         [style.left.px]="hoverCoords.x"
         [style.top.px]="hoverCoords.y">
    </div>
    
    <!-- Hover Tooltip -->
    <div class="hover-tooltip" 
         *ngIf="hoverCoords && hoverPoint"
         [style.left.px]="hoverCoords.x"
         [style.top.px]="hoverCoords.y">
      <div class="tooltip-content">
        <div class="tooltip-header">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          <span>Position</span>
        </div>
        <div class="tooltip-row">
          <span class="label">Cell:</span>
          <span class="value">({{ hoverPoint.cell.x }}, {{ hoverPoint.cell.y }})</span>
        </div>
        <div class="tooltip-row">
          <span class="label">World:</span>
          <span class="value">{{ hoverPoint.world.x | number:'1.2-2' }}m, {{ hoverPoint.world.y | number:'1.2-2' }}m</span>
        </div>
        <div class="tooltip-hint">Cliquer pour sélectionner</div>
      </div>
    </div>
    
    <!-- Selected Point Popup -->
    <div class="selected-popup" 
         *ngIf="selectedPoint && selectedCanvasCoords"
         [style.left.px]="selectedCanvasCoords.x"
         [style.top.px]="selectedCanvasCoords.y"
         [@popupAnimation]>
      <div class="popup-content">
        <div class="popup-header">
          <div class="popup-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </div>
          <h4>Point Sélectionné</h4>
          <button class="close-btn" (click)="clearSelection()" type="button">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="popup-body">
          <div class="info-row">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            <span class="info-label">Cellule:</span>
            <span class="info-value">({{ selectedPoint.cell.x }}, {{ selectedPoint.cell.y }})</span>
          </div>
          <div class="info-row">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="2" y1="12" x2="22" y2="12"></line>
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
            </svg>
            <span class="info-label">Monde:</span>
            <span class="info-value">x={{ selectedPoint.world.x | number:'1.2-2' }}m, y={{ selectedPoint.world.y | number:'1.2-2' }}m</span>
          </div>
        </div>
        <button class="popup-action-btn" (click)="addPoint()" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Ajouter au trajet
        </button>
      </div>
    </div>
  
    
    <!-- Map Status Indicator -->
    <div class="map-status" [class.map-status--loaded]="mapObj.map">
      <div class="status-dot"></div>
      <span>{{ mapObj.map ? 'Carte chargée' : 'En attente...' }}</span>
    </div>
  </div>
  
  <!-- Waypoints Panel (Collapsed by default) -->
  <div class="waypoints-panel" *ngIf="pointList.length">
    <div class="panel-header">
      <div class="panel-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"></line>
          <line x1="8" y1="12" x2="21" y2="12"></line>
          <line x1="8" y1="18" x2="21" y2="18"></line>
          <line x1="3" y1="6" x2="3.01" y2="6"></line>
          <line x1="3" y1="12" x2="3.01" y2="12"></line>
          <line x1="3" y1="18" x2="3.01" y2="18"></line>
        </svg>
        <h3>Waypoints ({{ pointList.length }})</h3>
      </div>
      <button class="send-all-btn" (click)="sendCoords()" type="button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
        Envoyer tout
      </button>
    </div>
    
    <div class="waypoints-list">
      <div class="waypoint-item" 
           *ngFor="let point of pointList; let idx = index; trackBy: trackByIndex">
        <div class="waypoint-number">{{ idx + 1 }}</div>
        <div class="waypoint-info">
          <div class="waypoint-coords">
            <span class="coord-label">Cell:</span>
            <span class="coord-value">({{ point.cell.x }}, {{ point.cell.y }})</span>
          </div>
          <div class="waypoint-coords">
            <span class="coord-label">World:</span>
            <span class="coord-value">{{ point.world.x | number:'1.2-2' }}m, {{ point.world.y | number:'1.2-2' }}m</span>
          </div>
        </div>
        <button class="remove-btn" (click)="removePoint(idx)" type="button" title="Retirer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>